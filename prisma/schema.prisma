generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// --- UTILIZADORES (Adicionada a Role e Planos) ---
model User {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String  @unique
  password  String?
  provider  String  @default("credentials")
  googleId  String?
  avatarUrl String?
  bio       String?
  role      Role    @default(STUDENT)

  // Novo: Controle de Acesso e Planos
  accessLevel      AccessType @default(FREE)
  isVerified       Boolean    @default(false)
  verificationCode String?

  // Gamificação
  xp              Int       @default(0)
  hearts          Int       @default(5)
  maxHearts       Int       @default(5)
  lastHeartUpdate DateTime? @default(now())

  streak           Int       @default(0)
  lastStreakUpdate DateTime?
  lastActive       DateTime? @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  wordProgress   Progress[]
  lessonProgress UserLesson[]
  calls          Call[]       @relation("UserCalls")
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

// --- DICIONÁRIO (MANTIDO CONFORME PEDIDO) ---
model Word {
  id              String     @id @default(auto()) @map("_id") @db.ObjectId
  term            String
  infinitive      String?
  meaning         String
  language        String     @default("Nhaneca-Humbe")
  category        String
  grammaticalType String?
  audioUrl        String?
  imageUrl        String?
  phonetic        String?
  duration        Float?
  culturalNote    String?
  searchTags      String[]
  tags            String[]
  synonyms        String[]
  examples        Example[]
  wordProgress    Progress[]
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model Example {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  text        String
  translation String
  audioUrl    String?
  wordId      String  @db.ObjectId
  word        Word    @relation(fields: [wordId], references: [id], onDelete: Cascade)
}

// --- ESTRUTURA DE GAMIFICAÇÃO REESTRUTURADA ---

model Level {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  order       Int
  title       String
  description String?
  language    String  @default("nhaneca")

  units     Unit[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Unit {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  order       Int
  title       String
  description String?

  levelId String @db.ObjectId
  level   Level  @relation(fields: [levelId], references: [id], onDelete: Cascade)

  lessons   Lesson[]
  createdAt DateTime @default(now())
}

model Lesson {
  id       String     @id @default(auto()) @map("_id") @db.ObjectId
  order    Int
  title    String
  xpReward Int        @default(10)
  access   AccessType @default(FREE)

  unitId String @db.ObjectId
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  // Mudança: De 'challenges' para 'activities' para incluir Teoria
  activities  Activity[]
  userHistory UserLesson[]
  createdAt   DateTime     @default(now())
}

model Activity {
  id    String       @id @default(auto()) @map("_id") @db.ObjectId
  order Int // Define a sequência: Teoria (1), Teoria (2), Desafio (3)...
  type  ActivityType

  // O campo question pode ser usado como título da Teoria ou pergunta do Desafio
  question String

  // JSON flexível para suportar:
  // Teoria: { "body": "Explicação aqui", "image": "url" }
  // Desafio Imagem: { "imageCorrect": "url", "imageWrong": "url", "correctAnswer": "..." }
  // Outros: { "options": [], "correct": "", "audioUrl": "" }
  content Json

  lessonId  String   @db.ObjectId
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

enum ActivityType {
  THEORY // Apenas conteúdo, não tira corações
  SELECT // Múltipla escolha
  TRANSLATE // Tradução
  ORDER // Ordenar palavras
  PAIRS // Combinar pares
  VOICE // Reconhecimento de fala (Whisper)
  IMAGE_CHECK // O novo tipo: Duas imagens (Certa vs Errada)
}

enum AccessType {
  FREE
  PREMIUM
  ENTERPRISE
}

// --- REGISTOS E COMUNICAÇÃO (MANTIDOS) ---

model UserLesson {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  lessonId    String   @db.ObjectId
  completedAt DateTime @default(now())
  score       Int
  user        User     @relation(fields: [userId], references: [id])
  lesson      Lesson   @relation(fields: [lessonId], references: [id])
}

model Progress {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  wordId     String   @db.ObjectId
  level      Int      @default(0)
  mastered   Boolean  @default(false)
  lastReview DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])
  word       Word     @relation(fields: [wordId], references: [id])
}

model Call {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  callerId  String    @db.ObjectId
  calleeId  String    @db.ObjectId
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  user      User      @relation("UserCalls", fields: [callerId], references: [id])
}
