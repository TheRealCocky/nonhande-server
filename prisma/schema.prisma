generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// --- UTILIZADORES ---
model User {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String  @unique
  password  String?
  provider  String  @default("credentials")
  googleId  String?
  avatarUrl String?
  bio       String?
  role      Role    @default(STUDENT)

  // NOVOS CAMPOS PARA SEGURANÇA REAL
  isVerified       Boolean @default(false) // Começa como falso até validar email
  verificationCode String? // Onde guardamos o código temporário

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  progress Progress[]
  calls    Call[]     @relation("UserCalls")
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

// --- DICIONÁRIO ---
model Word {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // --- CAMPOS PRINCIPAIS DE BUSCA ---
  term       String // Radical/Palavra original (ex: "lya", "hole")
  infinitive String? // Forma infinitiva (ex: "okulya", "okuhole")
  meaning    String // Tradução em Português

  // O campo que permite o Nonhande crescer para outras províncias
  language        String  @default("Nhaneca-Humbe") // Ex: Umbundu, Kimbundu
  category        String // Ex: Família, Verbo, Natureza
  grammaticalType String? // Ex: Verbo, Substantivo, Adjetivo

  // --- MULTIMÉDIA (Supabase Storage) ---
  audioUrl String? // Pronúncia nativa
  imageUrl String? // Ilustração do termo (Dataset visual)
  phonetic String? // Representação fonética
  duration Float? // Duração do áudio para o player

  // --- CONTEXTO E METADADOS ---
  culturalNote String? // Contexto histórico ou regional

  // searchTags: Guardará variações como [ndyilya, tulya, okulya]
  // para permitir links cruzados e busca inteligente
  searchTags String[]

  // Tags genéricas (as que já tinhas antes)
  tags     String[]
  synonyms String[] // Sinónimos na mesma língua nacional

  // --- RELAÇÕES ---
  examples Example[] // Frases de exemplo (Onde faremos os links cruzados)
  progress Progress[] // Progresso de aprendizagem dos utilizadores

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Example {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  text        String // Frase em Nhaneca
  translation String // Tradução da frase
  audioUrl    String?

  wordId String @db.ObjectId
  word   Word   @relation(fields: [wordId], references: [id], onDelete: Cascade)
}

// --- APRENDIZAGEM E GAMIFICAÇÃO ---
model Progress {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  wordId     String   @db.ObjectId
  level      Int      @default(0) // Nível de memorização
  mastered   Boolean  @default(false)
  lastReview DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  word Word @relation(fields: [wordId], references: [id])
}

// --- COMUNICAÇÃO (CHAMADAS) ---
model Call {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  callerId  String    @db.ObjectId
  calleeId  String    @db.ObjectId
  startedAt DateTime  @default(now())
  endedAt   DateTime?

  user User @relation("UserCalls", fields: [callerId], references: [id])
}
