generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// --- UTILIZADORES ---
model User {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String  @unique
  password  String?
  provider  String  @default("credentials")
  googleId  String?
  avatarUrl String?
  bio       String?
  role      Role    @default(STUDENT)

  accessLevel      AccessType @default(FREE)
  isVerified       Boolean    @default(false)
  verificationCode String?

  // Gamificação
  xp               Int       @default(0)
  hearts           Int       @default(5)
  maxHearts        Int       @default(5)
  lastHeartUpdate  DateTime? @default(now())
  voiceSampleUrl   String?
  streak           Int       @default(0)
  lastStreakUpdate DateTime?
  lastActive       DateTime? @default(now())

  // ✨ RELAÇÃO COM A MEMÓRIA (Corrigido: Apenas uma referência)
  memory UserMemory?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  wordProgress   Progress[]
  lessonProgress UserLesson[]
  hostedCalls    Call[]       @relation("HostCalls")

  ChatHistory ChatHistory[]

  UserDocument UserDocument[]
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

// --- DICIONÁRIO (MANTIDO INTACTO) ---
model Word {
  id              String     @id @default(auto()) @map("_id") @db.ObjectId
  term            String
  infinitive      String?
  meaning         String
  language        String     @default("Nhaneca-Humbe")
  category        String
  grammaticalType String?
  audioUrl        String?
  imageUrl        String?
  phonetic        String?
  duration        Float?
  culturalNote    String?
  searchTags      String[]
  tags            String[]
  synonyms        String[]
  examples        Example[]
  wordProgress    Progress[]
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model Example {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  text        String
  translation String
  audioUrl    String?
  wordId      String  @db.ObjectId
  word        Word    @relation(fields: [wordId], references: [id], onDelete: Cascade)
}

// --- ESTRUTURA DE GAMIFICAÇÃO (MODULO CORRIGIDO) ---

model Level {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  order       Int
  title       String
  description String?
  language    String  @default("nhaneca")

  units     Unit[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Unit {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  order       Int
  title       String
  description String?

  levelId String @db.ObjectId
  level   Level  @relation(fields: [levelId], references: [id], onDelete: Cascade)

  lessons   Lesson[]
  createdAt DateTime @default(now())
}

model Lesson {
  id       String     @id @default(auto()) @map("_id") @db.ObjectId
  order    Int
  title    String
  xpReward Int        @default(10)
  access   AccessType @default(FREE)

  unitId String @db.ObjectId
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  activities  Activity[]
  userHistory UserLesson[]
  createdAt   DateTime     @default(now())
}

model Activity {
  id       String       @id @default(auto()) @map("_id") @db.ObjectId
  order    Int
  type     ActivityType
  question String
  content  Json
  metadata Json? // NOVO: Para infos extras (dialeto, nível de respeito, etc.)
  lessonId String       @db.ObjectId
  lesson   Lesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

enum ActivityType {
  SELECT
  LISTEN_SELECT
  FILL_BLANK
  TRANSLATE
  LISTEN_ORDER
  SPEAK
  IMAGE_CHECK
  THEORY
  PAIRS
  VOICE
}

enum AccessType {
  FREE
  PREMIUM
  ENTERPRISE
}

// --- REGISTOS DE PROGRESSO (AQUI ESTÁ A MUDANÇA) ---

model UserLesson {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  userId   String @db.ObjectId
  lessonId String @db.ObjectId

  // NOVO: Controla se a lição foi terminada para desbloquear a próxima
  completed   Boolean   @default(false)
  completedAt DateTime?

  // NOVO: Guarda em qual atividade (pelo 'order') o aluno parou
  // Isso permite o "avançar e recuar" e salvar o estado ao sair
  lastActivityOrder Int @default(1)

  score  Int    @default(0)
  user   User   @relation(fields: [userId], references: [id])
  lesson Lesson @relation(fields: [lessonId], references: [id])

  // Garante que o user tenha apenas um registro de progresso por lição
  @@unique([userId, lessonId])
}

model Progress {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  wordId     String   @db.ObjectId
  level      Int      @default(0)
  mastered   Boolean  @default(false)
  lastReview DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])
  word       Word     @relation(fields: [wordId], references: [id])
}

// --- MEMÓRIA DE LONGO PRAZO (NONHANDE IA) ---
model UserMemory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @unique @db.ObjectId
  facts     String[] // Ex: ["Gosta da Huíla", "Interesse em Nhaneka"]
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

// --- HISTÓRICO DE CONVERSA (MEMÓRIA EPISÓDICA) ---
model ChatHistory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  query     String
  answer    String
  agent     String?
  createdAt DateTime @default(now())

  // ✨ GARANTE QUE ESTA RELAÇÃO EXISTE:
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserDocument {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  name   String
  url    String
  type   String
  size   Int

  isProcessed Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

// --- LIVE & VIDEOCHAMADAS ---
model Call {
  id     String  @id @default(auto()) @map("_id") @db.ObjectId
  roomId String  @unique // Ex: "aula-nhaneca-huila" ou UUID
  title  String? // Nome da sala/aula

  // Relação principal: O Professor/Anfitrião
  hostId String @db.ObjectId
  host   User   @relation("HostCalls", fields: [hostId], references: [id])

  isActive  Boolean   @default(true)
  startedAt DateTime  @default(now())
  endedAt   DateTime?

  // Mantemos como array de IDs para não complicar a performance no Render Free
  participants String[] @db.ObjectId

  createdAt DateTime @default(now())
  // ❌ REMOVI as linhas duplicadas de "User" e "userId" que estavam aqui em baixo
}
