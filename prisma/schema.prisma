generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// --- UTILIZADORES ---
model User {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String  @unique
  password  String?
  provider  String  @default("credentials")
  googleId  String?
  avatarUrl String?
  bio       String?
  role      Role    @default(STUDENT)

  accessLevel      AccessType @default(FREE)
  isVerified       Boolean    @default(false)
  verificationCode String?

  // Gamificação
  xp              Int       @default(0)
  hearts          Int       @default(5)
  maxHearts       Int       @default(5)
  lastHeartUpdate DateTime? @default(now())

  streak           Int       @default(0)
  lastStreakUpdate DateTime?
  lastActive       DateTime? @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  wordProgress   Progress[]
  lessonProgress UserLesson[]
  calls          Call[]       @relation("UserCalls")
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

// --- DICIONÁRIO (MANTIDO INTACTO) ---
model Word {
  id              String     @id @default(auto()) @map("_id") @db.ObjectId
  term            String
  infinitive      String?
  meaning         String
  language        String     @default("Nhaneca-Humbe")
  category        String
  grammaticalType String?
  audioUrl        String?
  imageUrl        String?
  phonetic        String?
  duration        Float?
  culturalNote    String?
  searchTags      String[]
  tags            String[]
  synonyms        String[]
  examples        Example[]
  wordProgress    Progress[]
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model Example {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  text        String
  translation String
  audioUrl    String?
  wordId      String  @db.ObjectId
  word        Word    @relation(fields: [wordId], references: [id], onDelete: Cascade)
}

// --- ESTRUTURA DE GAMIFICAÇÃO (MODULO CORRIGIDO) ---

model Level {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  order       Int
  title       String
  description String?
  language    String  @default("nhaneca")

  units     Unit[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Unit {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  order       Int
  title       String
  description String?

  levelId String @db.ObjectId
  level   Level  @relation(fields: [levelId], references: [id], onDelete: Cascade)

  lessons   Lesson[]
  createdAt DateTime @default(now())
}

model Lesson {
  id       String     @id @default(auto()) @map("_id") @db.ObjectId
  order    Int
  title    String
  xpReward Int        @default(10)
  access   AccessType @default(FREE)

  unitId String @db.ObjectId
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  activities  Activity[]
  userHistory UserLesson[]
  createdAt   DateTime     @default(now())
}

model Activity {
  id       String       @id @default(auto()) @map("_id") @db.ObjectId
  order    Int
  type     ActivityType
  question String
  content  Json

  lessonId String @db.ObjectId
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

enum ActivityType {
  SELECT
  LISTEN_SELECT
  FILL_BLANK
  TRANSLATE
  LISTEN_ORDER
  SPEAK
  IMAGE_CHECK
  THEORY
}

enum AccessType {
  FREE
  PREMIUM
  ENTERPRISE
}

// --- REGISTOS DE PROGRESSO (AQUI ESTÁ A MUDANÇA) ---

model UserLesson {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  userId   String @db.ObjectId
  lessonId String @db.ObjectId

  // NOVO: Controla se a lição foi terminada para desbloquear a próxima
  completed   Boolean   @default(false)
  completedAt DateTime?

  // NOVO: Guarda em qual atividade (pelo 'order') o aluno parou
  // Isso permite o "avançar e recuar" e salvar o estado ao sair
  lastActivityOrder Int @default(1)

  score  Int    @default(0)
  user   User   @relation(fields: [userId], references: [id])
  lesson Lesson @relation(fields: [lessonId], references: [id])

  // Garante que o user tenha apenas um registro de progresso por lição
  @@unique([userId, lessonId])
}

model Progress {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  wordId     String   @db.ObjectId
  level      Int      @default(0)
  mastered   Boolean  @default(false)
  lastReview DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])
  word       Word     @relation(fields: [wordId], references: [id])
}

model Call {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  callerId  String    @db.ObjectId
  calleeId  String    @db.ObjectId
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  user      User      @relation("UserCalls", fields: [callerId], references: [id])
}
