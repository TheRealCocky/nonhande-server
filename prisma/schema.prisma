generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// --- UTILIZADORES E PROGRESSÃO GLOBAL ---
model User {
  id               String  @id @default(auto()) @map("_id") @db.ObjectId
  name             String
  email            String  @unique
  password         String?
  provider         String  @default("credentials")
  googleId         String?
  avatarUrl        String?
  bio              String?
  role             Role    @default(STUDENT)
  isVerified       Boolean @default(false)
  verificationCode String?

  // Atributos de Gamificação (Padrão Duolingo)
  xp               Int       @default(0)
  hearts           Int       @default(5) // Vidas atuais
  maxHearts        Int       @default(5) // Limite de vidas
  lastHeartUpdate  DateTime  @default(now()) // Para calcular a regeneração de 2h
  streak           Int       @default(0) // Ofensiva de dias
  lastStreakUpdate DateTime? // Para verificar se jogou hoje/ontem
  lastActive       DateTime? @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  wordProgress   Progress[]
  lessonProgress UserLesson[]
  calls          Call[]       @relation("UserCalls")
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

// --- DICIONÁRIO (O ACERVO - INTACTO) ---
model Word {
  id              String  @id @default(auto()) @map("_id") @db.ObjectId
  term            String
  infinitive      String?
  meaning         String
  language        String  @default("Nhaneca-Humbe")
  category        String
  grammaticalType String?

  audioUrl String?
  imageUrl String?
  phonetic String?
  duration Float?

  culturalNote String?
  searchTags   String[]
  tags         String[]
  synonyms     String[]

  examples     Example[]
  wordProgress Progress[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Example {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  text        String
  translation String
  audioUrl    String?

  wordId String @db.ObjectId
  word   Word   @relation(fields: [wordId], references: [id], onDelete: Cascade)
}

// --- ESTRUTURA DE GAMIFICAÇÃO (PURIFICADA PARA MULTI-LÍNGUA) ---

model Level {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  order       Int
  title       String
  description String?
  language    String  @default("nhaneca")

  units     Unit[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Unit {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  order       Int
  title       String
  description String?

  levelId String @db.ObjectId
  level   Level  @relation(fields: [levelId], references: [id], onDelete: Cascade)

  lessons   Lesson[]
  createdAt DateTime @default(now())
}

model Lesson {
  id       String     @id @default(auto()) @map("_id") @db.ObjectId
  order    Int
  title    String
  xpReward Int        @default(10)
  access   AccessType @default(FREE)

  unitId String @db.ObjectId
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  challenges  Challenge[]
  userHistory UserLesson[]
  createdAt   DateTime     @default(now())
}

model Challenge {
  id       String        @id @default(auto()) @map("_id") @db.ObjectId
  type     ChallengeType
  question String

  content Json // { "options": [], "correct": "", "audioUrl": "" }

  lessonId  String   @db.ObjectId
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

enum ChallengeType {
  SELECT
  TRANSLATE
  ORDER
  PAIRS
  VOICE
}

enum AccessType {
  FREE
  PREMIUM
  ENTERPRISE
}

// --- REGISTOS DE PROGRESSO ---

model UserLesson {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  lessonId    String   @db.ObjectId
  completedAt DateTime @default(now())
  score       Int

  user   User   @relation(fields: [userId], references: [id])
  lesson Lesson @relation(fields: [lessonId], references: [id])
}

model Progress {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  wordId     String   @db.ObjectId
  level      Int      @default(0)
  mastered   Boolean  @default(false)
  lastReview DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  word Word @relation(fields: [wordId], references: [id])
}

// --- COMUNICAÇÃO ---
model Call {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  callerId  String    @db.ObjectId
  calleeId  String    @db.ObjectId
  startedAt DateTime  @default(now())
  endedAt   DateTime?

  user User @relation("UserCalls", fields: [callerId], references: [id])
}
